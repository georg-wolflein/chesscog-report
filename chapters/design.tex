\documentclass[../main.tex]{subfiles}

\begin{document}

\chapter{Design}
\section{Overview}
\input{chapters/design/dataset}

\section{A classification-based approach}
\subsection{Board detection}
\subsection{Occupancy classification}
Empirical experiments showed that performing piece classification directly after detecting the four corner points with no intermediate step yields a large number of false positives, i.e. empty squares being classified as containing a chess piece.
\begin{figure}
    \centering
    \begin{subfigure}[b]{0.65\textwidth}
        \centering
        \includegraphics[width=\textwidth]{3828_annotated}
        \caption{region from the original image with marked square}
        \label{fig:occupancy_classification_fp_original}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.3\textwidth}
        \centering
        \includegraphics[width=.7\textwidth]{3828_cut}
        \caption{cropped sample}
        \label{fig:occupancy_classification_fp_cropped}
    \end{subfigure}
    \caption[An example illustraing why an immediate piece classification approach is inclined to reporting false positives.]{An example illustraing why an immediate piece classification approach is inclined to reporting false positives. Consider the square marked in green in the original image \subref{fig:occupancy_classification_fp_original}. The bounding box for piece classification (marked in red) must be quite tall because the square might contain a tall piece such as a queen or king (the box must be at least as tall as the the queen in the adjacent square on the left). The resulting sample, depicted in \subref{fig:occupancy_classification_fp_cropped}, contains almost the entire rook of the square behind. Thus, a piece classifier might classify this square as containing a rook instead of being empty.}
    \label{fig:occupancy_classification_fp}
\end{figure}
One common scenario where the trained classifier failed is illustrated in \cref{fig:occupancy_classification_fp}.
Notice that squares further away from the camera must be cropped with increasingly taller bounding boxes.
If a particular square is empty but its bounding box includes the piece from the adjacent square as in \cref{fig:occupancy_classification_fp_cropped}, the trained classifier was inclined to report a false positive.

To solve this problem, a binary classifier was trained to 
\begin{figure}
    \centering
    \begin{subfigure}[b]{0.47\textwidth}
        \centering
        \includegraphics[width=\textwidth]{3828}
        \caption{original}
        \label{fig:occupancy_classification_samples_original}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.47\textwidth}
        \centering
        \includegraphics[width=\textwidth]{3828_unwarped}
        \caption{warped}
        \label{fig:occupancy_classification_samples_warped}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.47\textwidth}
        \centering
        \includegraphics[width=\textwidth]{3828_empty}
        \caption{all 32 empty samples}
        \label{fig:occupancy_classification_samples_empty}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.47\textwidth}
        \centering
        \includegraphics[width=\textwidth]{3828_occupied}
        \caption{all 24 occupied samples}
        \label{fig:occupancy_classification_samples_occupied}
    \end{subfigure}
    \caption[The process of obtaining samples for occupancy classification from a chessboard image.]{The process of obtaining samples for occupancy classification from a chessboard image. First, the original image \subref{fig:occupancy_classification_samples_original} is warped to a two-dimensional overhead view, \subref{fig:occupancy_classification_samples_warped}. Then, all squares are cropped (with a 50\% increase in width and height to include contextual information). Finally, the cropped squares are annoted using the \gls{fen} groundtruth as either empty \subref{fig:occupancy_classification_samples_empty} or occupied \subref{fig:occupancy_classification_samples_occupied}.}
    \label{fig:occupancy_classification_samples}
\end{figure}

\begin{table}
    \centering
    \pgfplotstabletypeset[
        col sep=tab,
        columns={context,run,val_accuracy,val_precision/occupied,val_recall/occupied,val_misclassified,train_accuracy},
        every head row/.style={%
            before row=\toprule,
            after row=\midrule%
        },
        every last row/.style={
            after row=\bottomrule
        },
        columns/run/.style={
            string type,
            column name={model}
        },
        columns/context/.style={
            string type,
            column name={}
        },
        columns/val_accuracy/.style={
            dec sep align,
            postproc cell content/.append code={
                \ifnum1=\pgfplotstablepartno
                    \pgfkeysalso{@cell content/.add={}{\%}}%
                \fi
            },
            fixed,
            fixed zerofill,
            column name={accuracy}
        },
        columns/train_accuracy/.style={
            dec sep align,
            postproc cell content/.append code={
                \ifnum1=\pgfplotstablepartno
                    \pgfkeysalso{@cell content/.add={}{\%}}%
                \fi
            },
            fixed,
            fixed zerofill,
            column name={\makecell{training \\ accuracy}}
        },
        columns/val_precision/occupied/.style={
            dec sep align,
            precision=3,
            fixed,
            fixed zerofill,
            column name={precision}
        },
        columns/val_recall/occupied/.style={
            dec sep align,
            precision=3,
            fixed,
            fixed zerofill,
            column name={recall}
        },
        columns/val_misclassified/.style={
            column name={\makecell{errors}}
        },
    ]{data/occupancy_classifier.dat}
    \caption[Performance of all occupancy classification models on the validation set.]{Performance of all occupancy classification models on the validation set. For the \gls{cnn} models, the 4-tuple denotes the length of the square input size in pixels, the number of convolution layers, the number of pooling layers, and the number of fully connected layers. The check mark in the left column indicates whether the input samples contained contextual information (cropped to include part of the adjacent squares). In the penultimate column, the total number of misclassifications in the validation set reported (the validation set consists of 9,346 samples). The training accuracy is given in the rightmost column for comparison. Notice that there is no significant difference between the validation and training accuracies, indicating that none of the models suffer from overfitting.}
\end{table}

\subsection{Piece classification}

\section{An approach based on object detection}
\section{Identifying plausible game states}

\end{document}